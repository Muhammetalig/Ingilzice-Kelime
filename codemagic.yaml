workflows:
  ios-workflow:
    name: iOS Workflow
    environment:
      xcode: latest
      cocoapods: default
      vars:
        XCODE_PROJECT: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        BUNDLE_ID: "com.example.englishwithgames"
        CERTIFICATE_PASSWORD: $CM_CERTIFICATE_PASSWORD
        KEYCHAIN_PASSWORD: $CM_KEYCHAIN_PASSWORD
        APP_STORE_CONNECT_ISSUER_ID: $CM_APP_STORE_CONNECT_ISSUER_ID
        APP_STORE_CONNECT_API_KEY_ID: $CM_APP_STORE_CONNECT_API_KEY_ID
        APP_STORE_CONNECT_API_KEY: $CM_APP_STORE_CONNECT_API_KEY
        TEAM_ID: $CM_TEAM_ID
    scripts:
      - name: Set up code signing settings
        script: |
          keychain_name="codemagic.keychain"
          keychain_password="$KEYCHAIN_PASSWORD"
          
          # Create temporary keychain
          security create-keychain -p "$keychain_password" "$keychain_name"
          security list-keychains -s "$keychain_name"
          security default-keychain -s "$keychain_name"
          security unlock-keychain -p "$keychain_password" "$keychain_name"
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/"$keychain_name"
          
          # Import certificates
          security import "ios/certs/distribution.p12" -k "$keychain_name" -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security import "ios/certs/development.p12" -k "$keychain_name" -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          
          # Add provisioning profiles
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/profiles/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          
          # Set partition list
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$keychain_password" "$keychain_name"
      - name: Get Flutter packages
        script: flutter pub get
             - name: Create export options plist
         script: |
           cat > /tmp/exportOptions.plist << EOF
           <?xml version="1.0" encoding="UTF-8"?>
           <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
           <plist version="1.0">
           <dict>
               <key>method</key>
               <string>app-store</string>
               <key>teamID</key>
               <string>$TEAM_ID</string>
               <key>signingStyle</key>
               <string>manual</string>
               <key>provisioningProfiles</key>
               <dict>
                   <key>$BUNDLE_ID</key>
                                       <string>EnglishWithGames_AppStore</string>
               </dict>
               <key>signingCertificate</key>
               <string>Apple Distribution</string>
               <key>uploadBitcode</key>
               <false/>
               <key>uploadSymbols</key>
               <true/>
               <key>compileBitcode</key>
               <false/>
           </dict>
           </plist>
           EOF
       - name: Flutter build ipa
         script: |
           flutter build ipa \
             --release \
             --export-options-plist=/tmp/exportOptions.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_API_KEY
        key_id: $APP_STORE_CONNECT_API_KEY_ID
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
        submit_to_app_store: false

  android-workflow:
    name: Android Workflow
    environment:
      flutter: stable
      android_signing:
        - keystore_reference
      vars:
        PACKAGE_NAME: "com.example.englishwithgames"
    scripts:
      - name: Get Flutter packages
        script: flutter pub get
      - name: Flutter build apk
        script: flutter build apk --release
      - name: Flutter build app bundle
        script: flutter build appbundle --release
    artifacts:
      - build/**/outputs/**/*.apk
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      google_play:
        track: internal
        submit_as_draft: true
